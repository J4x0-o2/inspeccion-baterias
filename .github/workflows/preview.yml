# ============================================
# CD: Preview autom치tico en Vercel
# Se ejecuta en: PRs a master
# ============================================

name: 游 Preview en Vercel

on:
  pull_request:
    branches:
      - master
      - main

jobs:
  preview:
    name: Crear Preview URL
    runs-on: ubuntu-latest
    
    steps:
      - name: 游닌 Checkout c칩digo
        uses: actions/checkout@v4
      
      - name: 游닍 Instalar Vercel CLI
        run: npm install -g vercel@latest
      
      - name: 游댕 Conectar con Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: vercel pull --yes --environment=preview
      
      - name: 游깷 Crear Preview
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        id: preview
        run: |
          PREVIEW_URL=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }})
          echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "Preview URL: $PREVIEW_URL"
      
      - name: 游눫 Comentar en PR
        uses: actions/github-script@v6
        with:
          script: |
            const previewUrl = "${{ steps.preview.outputs.PREVIEW_URL }}";
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `游댌 **Preview URL**: [${previewUrl}](${previewUrl})\n\nTu PR est치 siendo previewizado. Revisa los cambios antes de mergearlo a master.`
            });
